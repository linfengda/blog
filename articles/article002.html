<!DOCTYPE HTML>
<!--
	Massively by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Generic Page - Massively by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-loading">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
						<a href="../index.html" class="logo">Massively</a>
					</header>

				<!-- Nav -->
					<nav id="nav">
						<ul class="links">
							<li><a href="../index.html">Massively</a></li>
							<li class="active"><a href="../generic.html">Page guide</a></li>
						</ul>
					</nav>

				<!-- Main -->
					<div id="main">

						<!-- Post -->
							<section class="post">
								<header class="major">
									<span class="date">February 22, 2018</span>
									<h1>HTML transfer into PDF</h1>
									<p>PDF document is a popular document type in many ways, such as scientific paper/book/business report. in this blog, I am going to show you how to translate HTML document to PDF document, after reading my idea, you will realize that our imagination is limited by our understanding of code. </p>
								</header>
						    
              <!-- Definition area -->
                <h3>Definition</h3>
                <dl>
                  <dt>词法</dt>
                  <dd>
                    <p>词汇通常用正则表达式表示<br>INTEGER :0|[1-9][0-9]*<br>PLUS : +<br>MINUS: -<br></p>
                  </dd>
                  <dt>语法</dt>
                  <dd>
                    <p>语法通常使用一种称为 BNF 的格式来定义<br>expression :=  term  operation  term<br>operation :=  PLUS | MINUS<br>term := INTEGER | expression<br></p>
                  </dd>
                  <dt>iText</dt>
                  <dd>
                    <p>iText是一个操作PDF文档的开源项目，由java和.net编写。<br>
                    iText在能够创建标准PDF的同时，还能将XML、HTML、Web表单、CSS或者其他数据库文件转换成PDF，而且保证格式的标准统一。<br>
                    iText可以切割、合并文档，还对页面进行复制、导入和覆盖的操作，同时可以加入、编写结构更加丰富的多样化内容，比如条形码、水印、印章、表格和图片等。<br> 
                    </p>
                  </dd>
                </dl>

                <!-- Introduction area -->
                  <h3>浏览器解析HTML过程</h3>
                  <p>
                    <span class="image left"><img src="../images/How-browsers-work0.png" alt="" /></span>
                    作为超文本标记语言，HTML定义了展示网页信息一种规范。浏览器在解释HTML生成最终视图的时候，大概是这样的：
                    <br>1. 解析文档；
                    <br>2. 布局，为每个节点分配一个应出现在屏幕上的确切坐标；
                    <br>3. 绘制，呈现引擎会遍历呈现树，由用户界面后端层将每个节点绘制出来；
                    <br>4. 显示，值得注意的是这一步并不会等到文档解析完成，会将部分已解析的文档尽快显示。
                  </p>
                  <p>
                    <span><img src="../images/How-browsers-work1.png" alt="" /></span>
                    <br>图1：浏览器主要组件
                  </p>
                  <p>
                    <span><img src="../images/How-browsers-work2.png" alt="" /></span>
                    <br>图2：呈现引擎的基本流程
                  </p>
                  <p>
                    <span><img src="../images/How-browsers-work3.png" alt="" /></span>
                    <br>图3：WebKit 主流程
                  </p>


							<!-- Code area -->
								<pre>
									<code>
//假如一个HTML文档如下

&lt;!DOCTYPE html&gt;
&lt;html&gt;
 &lt;head&gt;
  &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot; /&gt;
 &lt;/head&gt;
 &lt;body&gt;
    &lt;!-- 诗词展示 --&gt;
      &lt;div style=&quot;font-family: msyh;text-align: center;&quot;&gt;

        &lt;h2&gt;早发白帝城&lt;/h2&gt;
        &lt;div style=&quot;padding: 20px 20px; background-color: rgb(250, 192, 143);font-family: simkai;&quot;&gt;
          朝辞白帝彩云间，千里江陵一日还。&lt;br /&gt;
          两岸猿声啼不住，轻舟已过万重山。&lt;br /&gt;
        &lt;/div&gt;

        &lt;h2&gt;赠汪伦&lt;/h2&gt;
        &lt;div style=&quot;padding: 20px 20px; background-color: rgb(250, 192, 143);font-family: simkai;&quot;&gt;
          李白乘舟将欲行，忽闻岸上踏歌声。&lt;br /&gt;
          桃花潭水深千尺，不及汪伦送我情。&lt;br /&gt;
        &lt;/div&gt;

        &lt;h2&gt;望庐山瀑布&lt;/h2&gt;
        &lt;div style=&quot;padding: 20px 20px; background-color: rgb(250, 192, 143);font-family: simkai;&quot;&gt;
          日照香炉生紫烟，遥看瀑布挂前川。&lt;br /&gt;
          飞流直下三千尺，疑是银河落九天。&lt;br /&gt;
        &lt;/div&gt;
  &lt;/div&gt;

  &lt;!-- 古词释义 --&gt;
    &lt;div style=&quot;text-shadow: 5px 5px 5px #787878;color: #fff;background-color: #CDC9C9;&quot;&gt;
      &lt;p&gt;&lt;span style=&quot;margin-right: 10px;&quot;&gt;☆&lt;/span&gt;发：启程。白帝城：故址在今重庆市奉节县白帝山上。&lt;/p&gt;
      &lt;p&gt;&lt;span style=&quot;margin-right: 10px;&quot;&gt;☆&lt;/span&gt;踏歌：唐代民间流行的一种手拉手、两足踏地为节拍的歌舞形式，可以边走边唱。&lt;/p&gt;
      &lt;p&gt;&lt;span style=&quot;margin-right: 10px;&quot;&gt;☆&lt;/span&gt;桃花潭：在今安徽泾县西南一百里。《一统志》谓其深不可测。深千尺：诗人用潭水深千尺比喻汪伦与他的友情，运用了夸张的手法。&lt;/p&gt;
    &lt;/div&gt;


 &lt;/body&gt;
&lt;/html&gt;
									</code>
								</pre>

                <p><span class="image right"><img src="../images/article002_001.png" alt="" /></span>
                需要解析这个文档，我们需要知道：文档中每个符号代表的意义不是固定的，而是配合当前文档上下文的语义来解释。这意味着，读取同样的字符，可能因为当前状态的不同，得到不同的下一个状态。<br>
                那么我们可以用数学的方式来解这道难题：<br>
                将解析HTML过程中当前状态抽象为“状态”，所有解析操作放在当前“状态”下执行。大概是这样的：<br>
                逐个读取文档字符，根据当前状态和读取到字符，进入对应状态机解析，并触发HTML文档生命周期事件。
                </p>

                <!-- Code area -->
                <pre>
                  <code>
/**
 * HTML符号识别算法
 * 每次读取一个输入字符，并根据这些字符转移到下一个状态，当前的符号状态和当前Dom树状态共同影响结果。
 * 这意味着，读取同样的字符，可能因为当前状态的不同，得到不同的下一个状态。
 * 
 * @param r
 * @throws IOException
 */
public void parse(final Reader r) throws IOException {
    for (HTMLLifeCycleListener l : listeners) {
      l.init();
    }
    char read[] = new char[1];
    try {
      while (-1 != (r.read(read))) {
        state.process(read[0]);
      }
    } finally {
      for (HTMLLifeCycleListener l : listeners) {
        l.close();
      }
      r.close();
    }
}
                  </code>
                </pre>

                <!-- Code area -->
                <pre>
                  <code>
/**
 * 表示解析HTML文档的生命周期
 * 
 * @author 玄葬
 *
 */
public interface HTMLLifeCycle {
  
  public HTMLLifeCycle addHTMLLifeCycleListenter(HTMLLifeCycleListener l);
  
  public HTMLLifeCycle removeHTMLLifeCycleListenter(HTMLLifeCycleListener l);
  
  /**
   * 当在开始标签前读取到任何内容时触发
   */
  public void unknownText();
  
  /**
   * 当读取到开始标签时触发
   */
  public void startElement();
  
  /**
   * 当读取到结束标签时触发
   */
  public void endElement();
  
  /**
   * 当读取到注释时触发
   */
  public void comment();
  
}
                  </code>
                </pre>

                <!-- Code area -->
                <pre>
                  <code>
/**
 * 观察者设计模式
 * 监听{@link HTMLLifeCycle}的生命周期事件
 * 
 * @author 玄葬
 *
 */
public interface HTMLLifeCycleListener {
  
  /**
   * 标签开始----->pipeline open方法----->生成PDF
   */
  void startElement(String tag, Map<String, String> attributes, String ns);

  /**
   * 标签结束----->pipeline close方法----->生成PDF
   */
  void endElement(String tag, String ns);
  
  /**
   * 标签内容----->pipeline content方法----->生成PDF
   */
  void text(String text);

  /**
   * 标签外内容
   */
  void unknownText(String text);

  /**
   * 注释
   */
  void comment(String comment);

  /**
   * 解析开始
   */
  void init();

  /**
   * 解析结束
   */
  void close();

}
                  </code>
                </pre>

                <!-- Code area -->
                <pre>
                  <code>
//例如读取到标签开始字符“<”，会进入这个状态，这个状态下是这样解析字符的。
public class TagEncounteredState implements State {
  
  private final HTMLParser parser;
  
  /**
   * @param parser the HTMLParser
   */
  public TagEncounteredState(final HTMLParser parser) {
    this.parser = parser;
  }

  @Override
  public void process(final char character) {
    String tag = this.parser.memory().textBuffString();
    if (Character.isWhitespace(character) || character == &#39;&gt;&#39; || character == &#39;/&#39; || character == &#39;:&#39; || character == &#39;?&#39; || tag.equals(&quot;!--&quot;)) {
      if (tag.length() &gt; 0) {
        if (tag.equals(&quot;!DOCTYPE&quot;)) {           //&lt;!DOCTYPE html&gt;
          this.parser.memory().resetTextBuffer();
          this.parser.memory().append(character);
          this.parser.stateController().doctype();
        }
        else if (tag.equals(&quot;!--&quot;)) {           //&lt;!-- this is a comment --&gt;
          this.parser.memory().resetTextBuffer();
          this.parser.memory().resetCommentBuff();
          this.parser.stateController().comment();
          /**
           * 避免&#39;&lt;!----&gt;&#39;这样的注释出错
           * 详见CommentState和CloseCommentState
           */
          if (character == &#39;-&#39;) {
            this.parser.memory().commentBuff().append(character);
          } else {
            this.parser.memory().append(character);
          }
        }
        else if (Character.isWhitespace(character)) {   //&lt;p style=&quot;font-size: 14px;&quot;&gt;
          this.parser.memory().setCurrentTag(tag);
          this.parser.memory().resetTextBuffer();
          this.parser.stateController().tagAttributes();
        }
        else if (character == &#39;&gt;&#39;) {
          this.parser.memory().setCurrentTag(tag);
          this.parser.memory().resetTextBuffer();
          this.parser.startElement();
          this.parser.stateController().inTag();
        }
        else if (character == &#39;/&#39;) {
          this.parser.memory().setCurrentTag(tag);
          this.parser.memory().resetTextBuffer();
          this.parser.stateController().selfClosing();
        }
        else if (character == &#39;:&#39;) {
          this.parser.memory().setCurrentNameSpace(tag);
          this.parser.memory().resetTextBuffer();
        }
        
      } else {
        if (character == &#39;/&#39;) {               //&lt;/div
          this.parser.stateController().closingTag();
        }
        else if (character == &#39;?&#39;) {            //&lt;? xml
          this.parser.memory().append(character);
                    this.parser.stateController().processingInstructions();
        }
      }
    } else {
      this.parser.memory().append(character);         //&lt;div
    }
  }

}
                  </code>
                </pre>




							</section>
					</div>



				<!-- Copyright -->
					<div id="copyright">
						<ul><li>&copy; Untitled</li><li>Design: <a href="https://github.com/linfengda">genius_lin</a></li></ul>
					</div>

			</div>

		<!-- Scripts -->
			<script src="../assets/js/jquery.min.js"></script>
			<script src="../assets/js/jquery.scrollex.min.js"></script>
			<script src="../assets/js/jquery.scrolly.min.js"></script>
			<script src="../assets/js/skel.min.js"></script>
			<script src="../assets/js/util.js"></script>
			<script src="../assets/js/main.js"></script>

	</body>
</html>